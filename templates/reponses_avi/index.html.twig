{% extends 'basebackoffice.html.twig' %}

{% block title %}Gestion des Réponses aux Avis{% endblock %}

{% block body %}
  <!-- Page Heading -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800 font-weight-bold">Gestion des Réponses aux Avis</h1>
    <a href="{{ path('app_reponses_avi_new') }}" class="d-none d-sm-inline-block btn btn-primary shadow-sm">
      <i class="fas fa-plus fa-sm mr-1"></i> Nouvelle Réponse
    </a>
  </div>

  <!-- DataTales Example -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-gradient-primary text-white">
      <h6 class="m-0 font-weight-bold">Liste des Réponses</h6>
      <div class="dropdown no-arrow">
        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-ellipsis-v fa-sm fa-fw text-white-50"></i>
        </a>
        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
             aria-labelledby="dropdownMenuLink">
          <div class="dropdown-header">Actions :</div>
          <a class="dropdown-item" href="{{ path('app_reponses_avi_new') }}">
            <i class="fas fa-plus mr-1"></i> Ajouter une réponse
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="#">
            <i class="fas fa-file-export mr-1"></i> Exporter les données
          </a>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
          <thead class="thead-light">
          <tr>
            <th class="text-center">ID</th>
            <th>Commentaire original</th>
            <th>Réponse</th>
            <th class="text-center">Date</th>
            <th class="text-center" style="width: 140px;">Actions</th>
          </tr>
          </thead>
          <tbody>
          {% for reponses_avi in reponses_avis %}
            <tr>
              <td class="text-center align-middle">{{ reponses_avi.idReponse }}</td>
              <td class="align-middle">
                {% if reponses_avi.avi %}
                  <div class="comment-preview mr-2" data-toggle="tooltip" title="{{ reponses_avi.avi.commentaire }}">
                    {{ reponses_avi.avi.commentaire|length > 30 ? reponses_avi.avi.commentaire|slice(0, 30) ~ '...' : reponses_avi.avi.commentaire }}
                  </div>
                {% else %}
                  <span class="text-muted font-italic">Aucun commentaire associé</span>
                {% endif %}
              </td>
              <td class="align-middle">
                <div class="comment-preview mr-2" data-toggle="tooltip" title="{{ reponses_avi.reponse }}">
                  {{ reponses_avi.reponse|length > 50 ? reponses_avi.reponse|slice(0, 50) ~ '...' : reponses_avi.reponse }}
                </div>
              </td>
              <td class="text-center align-middle">{{ reponses_avi.dateReponse ? reponses_avi.dateReponse|date('d/m/Y H:i') : '' }}</td>
              <td class="text-center align-middle">
                <div class="d-flex justify-content-center">
                  <a href="{{ path('app_reponses_avi_show', {'id_reponse': reponses_avi.idreponse}) }}"
                     class="btn btn-sm btn-circle btn-info mx-1" title="Voir détails">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{{ path('app_reponses_avi_edit', {'id_reponse': reponses_avi.idreponse}) }}"
                     class="btn btn-sm btn-circle btn-primary mx-1" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </a>
                  <button type="button" class="btn btn-sm btn-circle btn-danger mx-1" data-toggle="modal"
                          data-target="#deleteModal{{ reponses_avi.idReponse }}" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>

                  <!-- Delete Modal -->
                  <div class="modal fade" id="deleteModal{{ reponses_avi.idReponse }}" tabindex="-1" role="dialog"
                       aria-labelledby="deleteModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                      <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                          <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          Êtes-vous sûr de vouloir supprimer cette réponse ?<br>
                          <strong>ID :</strong> {{ reponses_avi.idReponse }}
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                          <form method="post" action="{{ path('app_reponses_avi_delete', {'id_reponse': reponses_avi.idreponse}) }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reponses_avi.idreponse) }}">
                            <button type="submit" class="btn btn-danger">
                              <i class="fas fa-trash mr-1"></i> Supprimer
                            </button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="5" class="text-center py-5">
                <div class="empty-state">
                  <i class="fas fa-comment-slash fa-3x text-gray-400 mb-3"></i>
                  <h4 class="text-muted">Aucune réponse trouvée</h4>
                  <p class="text-muted mb-4">Vous n'avez pas encore créé de réponse aux avis.</p>
                  <a href="{{ path('app_reponses_avi_new') }}" class="btn btn-primary">
                    <i class="fas fa-plus mr-1"></i> Créer une réponse
                  </a>
                </div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    $(document).ready(function() {
      $('#dataTable').DataTable({
        language: {
          url: "//cdn.datatables.net/plug-ins/1.10.21/i18n/French.json"
        },
        responsive: true,
        autoWidth: false,
        order: [[3, 'desc']],
        columnDefs: [
          { responsivePriority: 1, targets: 0 },
          { responsivePriority: 2, targets: -1 },
          { responsivePriority: 3, targets: 3 },
          { responsivePriority: 4, targets: 2 },
          { responsivePriority: 5, targets: 1 }
        ],
        dom: '<"top"f>rt<"bottom"lip><"clear">',
        initComplete: function() {
          this.api().columns.adjust().responsive.recalc();
        }
      });

      $('[data-toggle="tooltip"]').tooltip({
        placement: 'top',
        trigger: 'hover',
        animation: true
      });

      $('.modal').on('shown.bs.modal', function() {
        $('body').addClass('modal-open');
      });
    });

    $(window).on('resize', function() {
      if ($.fn.DataTable.isDataTable('#dataTable')) {
        $('#dataTable').DataTable().columns.adjust().responsive.recalc();
      }
    });
  </script>
{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    .card {
      border: none;
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .card-header {
      border-bottom: none;
    }

    .bg-gradient-primary {
      background: linear-gradient(87deg, #4e73df 0, #224abe 100%) !important;
    }

    .btn-circle {
      width: 30px;
      height: 30px;
      padding: 0;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .table {
      font-size: 0.9rem;
    }

    .table thead th {
      border-bottom: 2px solid #e3e6f0;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
    }

    .table td, .table th {
      vertical-align: middle;
      padding: 0.75rem 1rem;
    }

    .comment-preview {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .empty-state {
      padding: 2rem 0;
      text-align: center;
    }

    .empty-state i {
      opacity: 0.6;
    }

    .modal-content {
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
    }

    @media (max-width: 768px) {
      .table-responsive {
        border: none;
      }

      .btn-circle {
        width: 25px;
        height: 25px;
        font-size: 0.8rem;
      }

      .comment-preview {
        max-width: 120px;
      }
    }
  </style>
{% endblock %}
